require "bundler/gem_tasks"
require "json"
require "fileutils"
require "openstudio"
# begin
#   Bundler.setup
# rescue Bundler::BundlerError => e
#   warn e.message
#   warn "Run `bundle install` to install missing gems"
#   exit e.status_code
# end

# require "rake/testtask"

# Tasks to manage the spreadsheet data
# namespace :data do
require "#{File.dirname(__FILE__)}/data/standards/manage_OpenStudio_Standards.rb"

# OpenStudio Standards spreadsheet names
# Order matters: most general/shared must be first,
# as data may be overwritten when parsing later spreadsheets.
spreadsheets_ashrae = [
  "OpenStudio_Standards-ashrae_90_1",
  "OpenStudio_Standards-ashrae_90_1(space_types)",
  "OpenStudio_Standards-ashrae_90_1_prm",
  "OpenStudio_Standards-ashrae_90_1_prm(space_types)",
]

spreadsheets_deer = [
  "OpenStudio_Standards-deer",
  "OpenStudio_Standards-deer(space_types)",
]

spreadsheets_comstock = [
  "OpenStudio_Standards-ashrae_90_1",
  "OpenStudio_Standards-ashrae_90_1-ALL-comstock(space_types)",
  "OpenStudio_Standards-deer",
  "OpenStudio_Standards-deer-ALL-comstock(space_types)",
]

spreadsheets_cbes = [
  "OpenStudio_Standards-cbes",
  "OpenStudio_Standards-cbes(space_types)",
]

spreadsheet_titles = spreadsheets_ashrae + spreadsheets_deer + spreadsheets_comstock + spreadsheets_cbes
spreadsheet_titles = spreadsheet_titles.uniq

spreadsheet_titles = ["OpenStudio_Standards-ashrae_90_1"]
pp download_google_spreadsheets(spreadsheet_titles)

pp export_spreadsheet_to_json(spreadsheet_titles)
put
desc "Check Google Drive configuration"
task "apicheck" do
  check_google_drive_configuration
end

desc "Download OpenStudio_Standards spreadsheets from Google Drive"
task "download" do
  download_google_spreadsheets(spreadsheet_titles)
end

desc "Download OpenStudio_Standards spreadsheets and generate JSONs"
task "update" do
  download_google_spreadsheets(spreadsheet_titles)
  export_spreadsheet_to_json(spreadsheet_titles)
end

desc "Generate JSONs from OpenStudio_Standards spreadsheets"
task "update:manual" do
  export_spreadsheet_to_json(spreadsheet_titles)
end

desc "Export JSONs from OpenStudio_Standards to data library"
task "export:jsons" do
  export_spreadsheet_to_json(spreadsheets_ashrae, dataset_type: "data_lib")
end
put
# end

# Tasks to export libraries packaged with
# the OpenStudio installer
namespace :library do
  require "#{File.dirname(__FILE__)}/data/standards/export_OpenStudio_libraries.rb"
  desc "Export libraries for OpenStudio installer"
  task "export" do
    export_openstudio_libraries
  end
end
